'use strict';window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,$(()=>Game.load());var Game=(()=>{function a(){return l.lost||l.won}function b(){Grid.movesAvailable(s.vectorMap)||(l.lost=!0),a()&&g()}function c(){k=0,m=1,l={lost:!1,won:!1},o=!1,Md5(),clearInterval(q),clearInterval(r),GridDisplay.updateTimer(),Grid.build(),Grid.addStartTiles(),GridDisplay.refresh(Grid.eachCell,m,k),GridDisplay.message("start-off"),p=GridDisplay.message("load-on"),Questions.array(!1),$.ajax({url:`${SITE_URL}game/load_game`,dataType:"JSON",success:a=>a.forEach(a=>Questions.array(a))}).done(()=>{p=GridDisplay.message("load-off"),GridDisplay.message("start-on")})}function d(){m++;$.ajax({url:`${SITE_URL}game/get_questions`,dataType:"JSON",success:a=>a.forEach(a=>Questions.array(a))})}function f(){if(o)return!0;$.ajax({url:`${SITE_URL}game/start_game`}),GridDisplay.message("start-off"),n=Date.now();let a;q=setInterval(()=>{a=Date.now()-n,GridDisplay.updateTimer(a)},1e3),o=!0}function g(){let a=l.lost?"lost":"won";setTimeout(()=>Modal.gameOver(a),1500),clearInterval(q),clearInterval(r);let b=Math.floor((Date.now()-n)/1e3);$.ajax({url:`${SITE_URL}game/end_game/${k}/${b}`})}function h(c){let d=a()||!Grid.allTileValuesSet();if(!d){let a=Grid.move(c);if(a){Grid.addRandomTile();let c=Grid.getMaxMerge(!0);9999<=c&&(l.won=!0),k=l.won?9999:c,GridDisplay.refresh(Grid.eachCell,m,k),b(a)}}}function i(){if(p||a()||Grid.allTileValuesSet())return;2===Questions.array().length&&d();let b=Questions.get(),c=()=>{Modal.showQuestion(b),Modal.onAnswer(j)};b?c():(p=GridDisplay.message("load-on"),r=setInterval(()=>{b=Questions.get(),b&&(clearInterval(r),p=GridDisplay.message("load-off"),c())},500))}function j(a){let c=Questions.scoreAnswer(a,Md5);GridDisplay.setTileValue(parseFloat(c),Grid.cells),b()}let k,l,m,n,o,p,q,r;var s=(()=>{function a(a){switch(a.type){case"keydown":g(a);break;case"touchstart":let c=a.changedTouches[0];j=c.pageX,k=c.pageY;break;case"touchmove":l=!0;break;case"touchend":l?(d(a),l=!1):b(a);}}function b(a){let b=$(a.target);if(b.is(".instruction-btn"))return;let c=b.is("#game-container")||0!==b.parents("#game-container").length,d=b.is(".modal")||0!==b.parents(".modal").length;c?f()&&i():d&&($(a.target).is(".carousel-indicators li")||Modal.nextAnswer())}function d(a){let b=$(a.target),c=b.is("#game-section")||0!==b.parents("#game-section").length,d=b.is(".modal")||0!==b.parents(".modal").length,e=50,f=100,g=a.changedTouches[0],i=g.pageX-j,l=g.pageY-k;if(Math.abs(i)>=e&&Math.abs(l)<=f?a.direction=0>i?3:1:Math.abs(l)>=e&&Math.abs(i)<=f&&(a.direction=0>l?0:2),c){let b=o[a.direction];b&&h(b)}else d&&void 0!==a.direction&&Modal.move(a.direction)}function g(a){if($(a.target).is(".modal")){switch(a.which){case 32:Modal.nextAnswer();break;case 38:case 37:case 40:case 39:let b=n[a.which];Modal.move(b);}return}switch(a.which){case 32:if($(a.target).is("button"))break;f()&&i();break;case 38:case 37:case 40:case 39:let b=n[a.which],c=o[b];c&&h(c);}}let j,k,l=!1,m=$(".btn-new-game"),n={38:0,39:1,40:2,37:3},o={0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}};m.click(()=>{$("#game-section").focus(),c()}),$(".modal").on("hidden.bs.modal",()=>$("#game-section").focus()),$(document).on("keydown touchstart touchmove touchend",a);return{vectorMap:o}})();return{load:c}})(),Grid=(()=>{function a(a,b){this.x=a.x,this.y=a.y,this.floatValue=b,this.isMaxMerge=!1,this.previousPosition=null,this.parentTiles=null}function b(){let b=m();if(b){let c=new a(b);n(c)}}function c(){r=4;for(let a,b=0;b<r;b++){a=s[b]=[];for(let b=0;b<r;b++)a.push(null)}}function d(a){let b={x:[],y:[]};for(let c=0;c<r;c++)b.x.push(c),b.y.push(c);return 1===a.x&&(b.x=b.x.reverse()),1===a.y&&(b.y=b.y.reverse()),b}function e(a,b){if(!a||!b)return!1;return 0==a%2==(0==b%2)}function f(a){return 0<=a.x&&a.x<r&&0<=a.y&&a.y<r}function g(a){return f(a)?s[a.x][a.y]:null}function h(a,b){let c;do c=a,a={x:c.x+b.x,y:c.y+b.y};while(f(a)&&null===g(a));return{farthest:c,next:a}}function i(){k((a,b,c)=>{c&&(c.parentTiles=null,c.savePosition())})}function j(a){let b=null;return k((a,c,d)=>{d&&d.isMaxMerge&&(b=d)}),a?b?b.getIntValue():0:b}function k(a){let b;for(let c=0;c<r;c++)for(let d=0;d<r;d++)if(b=a(c,d,s[c][d]),!1===b)return}function l(a){let b=!a&&[];return k((c,d,e)=>{if(!e)return a?b=!0:b.push({x:c,y:d}),!1}),b}function m(){let a=l();if(a.length)return a[Math.floor(Math.random()*a.length)]}function n(a){s[a.x][a.y]=a}function o(a){s[a.x][a.y]=null}function p(a,b){s[a.x][a.y]=null,s[b.x][b.y]=a,a.updatePosition(b)}function q(a){let b=j();b?a.floatValue>b.floatValue&&(b.isMaxMerge=!1,a.isMaxMerge=!0,b=a):(a.isMaxMerge=!0,b=a)}let r,s=[];a.prototype.savePosition=function(){this.previousPosition={x:this.x,y:this.y}},a.prototype.updatePosition=function(a){this.x=a.x,this.y=a.y},a.prototype.getIntValue=function(){return Math.floor(this.floatValue)};return{cells:s,build:c,getMaxMerge:j,move:function(b){let c,f,j=!1,k=d(b);return i(),k.x.forEach(d=>{k.y.forEach(i=>{if(c={x:d,y:i},f=g(c),f){let d=h(c,b),i=g(d.next),k=i&&!i.parentTiles&&e(i.getIntValue(),f.getIntValue());if(!k)p(f,d.farthest);else{let b=f.floatValue+i.floatValue;9999<b&&(b=9999);let c=new a(d.next,b);c.parentTiles=[f,i],n(c),o(f),f.updatePosition(d.next),q(c)}j=j||c.x!==f.x||c.y!==f.y}})}),j},movesAvailable:function(a){if(l(!0))return!0;let b,c,d,f,h,i=!1;return k((j,k,l)=>{d=l.getIntValue();for(let m=0;4>m;m++)f=a[m],b={x:j+f.x,y:k+f.y},c=g(b),l.floatValue?h=c&&e(d,c.getIntValue()):void 0===l.floatValue&&(h=c&&c.floatValue),h&&(i=!0);if(i)return!1}),i},eachCell:k,addRandomTile:b,addStartTiles:function(){for(let a=0;2>a;a++)b()},allTileValuesSet:function(){let a=!0;return k((b,c,d)=>{if(d&&void 0===d.floatValue)return a=!1,!1}),a}}})(),GridDisplay=(()=>{function a(a){for(let b,c=0;c<7;c++)b=Math.pow(-1,c)*20/(c*.8),a.animate({top:b},100);a.animate({top:0},100)}function b(b){b>g&&a(o),g=b,o.text(g)}function c(b){b>f&&a(p),f=b,p.text(f.toString().padStart(4,"0"))}function d(a){let b=a.x+1,c=a.y+1;return"tile-position-"+b+"-"+c}function e(a){let b=d(a.previousPosition||a),c=a.floatValue===void 0?"tile-new":0===a.floatValue?"tile-zero":0==a.getIntValue()%2?"tile-even":"tile-odd",f=["tile",c,b],g=a.floatValue===void 0?"?":0===a.floatValue?"X":a.getIntValue();a.isMaxMerge&&f.push("tile-max");let j=h.clone();j.attr("class",f.join(" ")),j.attr("id",""),j.data("x",a.x),j.data("y",a.y),j.text(g),a.previousPosition?window.requestAnimationFrame(()=>{f[2]=d(a),j.attr("class",f.join(" "))}):a.parentTiles&&(f.push("tile-merged"),j.attr("class",f.join(" ")),a.parentTiles.forEach(a=>{e(a)})),i.append(j)}let f=0,g=1,h=$("#tile-template"),i=$("#tile-container"),j=$("#game-section"),k=$("#game-message"),l=$("#loading-msg"),m=$(".start-msg"),n=$("#game-level-msg"),o=$("#game-level"),p=$("#game-score"),q=$("#game-timer");return{refresh:function(a,d,f){window.requestAnimationFrame(()=>{i.empty(),a((a,b,c)=>{c&&e(c)}),b(d),c(f)})},message:function(a){switch(a){case"load-on":return l.removeClass("d-none"),k.removeClass("d-none"),!0;case"load-off":return k.addClass("d-none"),l.addClass("d-none"),!1;case"start-on":k.removeClass("d-none"),m.removeClass("d-none");break;case"start-off":m.addClass("d-none"),k.addClass("d-none");}},updateTimer:function(a){if(!a)return void q.text("00:00");let b=Math.floor(a/1e3),c=Math.floor(b/60);b-=60*c,b=b.toString().padStart(2,"0"),c=c.toString().padStart(2,"0"),q.text(`${c}:${b}`)},setTileValue:function(a,b){let c=Math.floor(a),d=$(".tile-new").eq(0),e=d.data("x"),f=d.data("y"),g=b[e][f];g.floatValue=a,d.text(0===a?"X":c),d.data("val-set","1"),d.addClass(0===a?"tile-zero btn-light focus disabled":0==c%2?"tile-even btn-primary focus disabled":"tile-odd btn-danger focus disabled"),d.removeClass("tile-new")}}})(),Questions=(()=>{function a(){return h&&(g=f.shift(),g&&(h=!1)),g}function b(a,b){let c=g.ah;switch(g.type){case"boolean":return 1===a?b(c,"True"):0===a?b(c,"False"):b(c);case"multiple":return 0===a||1===a||2===a||3===a?b(c,g.optionsTrim[a]):b(c);}}function c(a){switch(g.type){case"boolean":switch(a){case"top":case"right":return 1;case"bottom":case"left":return 0;}case"multiple":switch(a){case"top":return 0;case"right":return 1;case"bottom":return 2;case"left":return 3;}}}function d(a,d){let e=a?c(a):"",f=b(e,d),i=g.id,j=0;$.ajax({url:`${SITE_URL}game/score_user_answer/${i}/${e}`});let k="boolean"===g.type?1===e?"True":0===e?"False":void 0:g.optionsTrim[e];return console.log("chose: "+k),console.log("right: "+g.correct),console.log("nhash: "+f),console.log("chash: "+g.hashes[e]),console.log("ahash: "+g.ah),f===g.hashes[e]?console.log("correct scoring"):alert("incorrect scoring"),console.log("-------------"),f===g.ah&&(j=g.score),h=!0,j}function e(a){if(a)f.push(a);else if(!1===a)f=[],h=!0;else return f}let f,g,h;return{array:e,current:()=>g,get:a,scoreAnswer:d}})(),Modal=(()=>{function a(a){let b=1e3*a,c=Date.now(),e=c+b+700,i=0,j=0,k=0;f=!1,g=!1;let l=()=>{f||(i++,k=i%6,0==k&&(h.css("width",`${j}%`),j=100*(16.667*i/b),c=Date.now()),c>=e?(g=!0,d.modal("hide"),h.css("width",0)):window.requestAnimationFrame(l))};window.requestAnimationFrame(l)}function b(a){if(!g&&(f=!0,!e.attr("style"))){0===a?c="top":1===a?c="right":2===a?c="bottom":3===a?c="left":void 0;let b={};b[c]="-500px",b.opacity="0",e.animate(b,"fast").promise().then(()=>{d.modal("hide")})}}let c,d=$(".modal-qtn"),e=d.find(".modal-content"),f=!1,g=!1,h=$(".progress-bar"),i=$("#modal-qtn-boolean"),j=i.find(".modal-body"),k=$("#modal-qtn-options"),l=k.find(".modal-body").eq(0),m=k.find(".modal-body").eq(1),n=k.find(".modal-body").eq(2),o=k.find(".modal-body").eq(3),p=k.find(".modal-body").eq(4),q=$("#modal-options-progress"),r=$("#modal-qtn-carousel"),s=$("#modal-game-over"),t=$("#modal-game-won"),u=$("#modal-instructions"),v=$("#modal-select-mode"),w=$("#modal-select-mode-carousel");d.on("show.bs.modal",function(){e.removeAttr("style"),r.carousel(0)}),v.on("show.bs.modal",()=>w.carousel(0));return{nextAnswer:function(){r.carousel("next")},move:b,showQuestion:function(b){switch(b.type){case"multiple":l.html(b.question),m.html(b.options[0]),n.html(b.options[1]),o.html(b.options[2]),p.html(b.options[3]),k.modal("show"),a(10);break;case"boolean":j.html(b.question),i.modal("show"),a(5);}},onAnswer:function(a){d.on("hide.bs.modal",()=>a(c)),d.on("hidden.bs.modal",()=>{d.off("hide.bs.modal"),d.off("hidden.bs.modal"),c=null})},gameOver:function(a){"lost"===a?s.modal("show"):"won"===a?t.modal("show"):void 0}}})(),Md5=(()=>{function a(a,d){if(!a)return void(c="");if(!d)return void(c=a);let e=b(d),f=b(c+e);return c=a,f}function b(a){function x(c,a){return c<<a|c>>>32-a}function f(h,a){var b,i,j,k,l;return j=2147483648&h,k=2147483648&a,b=1073741824&h,i=1073741824&a,l=(1073741823&h)+(1073741823&a),b&i?2147483648^l^j^k:b|i?1073741824&l?3221225472^l^j^k:1073741824^l^j^k:l^j^k}function g(d,a,b){return d&a|~d&b}function E(d,a,b){return d&b|a&~b}function F(d,a,b){return d^a^b}function k(d,a,b){return a^(d|~b)}function b(a,h,i,b,c,d,j){return a=f(a,f(f(g(h,i,b),c),j)),f(x(a,d),h)}function c(a,g,h,b,c,d,i){return a=f(a,f(f(E(g,h,b),c),i)),f(x(a,d),g)}function d(a,g,h,b,c,d,i){return a=f(a,f(f(F(g,h,b),c),i)),f(x(a,d),g)}function h(a,g,h,b,c,d,i){return a=f(a,f(f(k(g,h,b),c),i)),f(x(a,d),g)}function i(i){for(var a,j=i.length,c=j+8,d=16*((c-c%64)/64+1),e=Array(d-1),f=0,k=0;k<j;)a=(k-k%4)/4,f=8*(k%4),e[a]|=i.charCodeAt(k)<<f,k++;return a=(k-k%4)/4,f=8*(k%4),e[a]|=128<<f,e[d-2]=j<<3,e[d-1]=j>>>29,e}function j(f){var a,g,h="",i="";for(g=0;3>=g;g++)a=255&f>>>8*g,i="0"+a.toString(16),h+=i.substr(i.length-2,2);return h}function l(c){c=c.replace(/\r\n/g,"\n");for(var f,g="",h=0;h<c.length;h++)f=c.charCodeAt(h),128>f?g+=String.fromCharCode(f):127<f&&2048>f?(g+=String.fromCharCode(192|f>>6),g+=String.fromCharCode(128|63&f)):(g+=String.fromCharCode(224|f>>12),g+=String.fromCharCode(128|63&f>>6),g+=String.fromCharCode(128|63&f));return g}var m,n,o,p,q,r,s,G,H,I=[];for(a=l(a),I=i(a),r=1732584193,s=4023233417,G=2562383102,H=271733878,m=0;m<I.length;m+=16)n=r,o=s,p=G,q=H,r=b(r,s,G,H,I[m+0],7,3614090360),H=b(H,r,s,G,I[m+1],12,3905402710),G=b(G,H,r,s,I[m+2],17,606105819),s=b(s,G,H,r,I[m+3],22,3250441966),r=b(r,s,G,H,I[m+4],7,4118548399),H=b(H,r,s,G,I[m+5],12,1200080426),G=b(G,H,r,s,I[m+6],17,2821735955),s=b(s,G,H,r,I[m+7],22,4249261313),r=b(r,s,G,H,I[m+8],7,1770035416),H=b(H,r,s,G,I[m+9],12,2336552879),G=b(G,H,r,s,I[m+10],17,4294925233),s=b(s,G,H,r,I[m+11],22,2304563134),r=b(r,s,G,H,I[m+12],7,1804603682),H=b(H,r,s,G,I[m+13],12,4254626195),G=b(G,H,r,s,I[m+14],17,2792965006),s=b(s,G,H,r,I[m+15],22,1236535329),r=c(r,s,G,H,I[m+1],5,4129170786),H=c(H,r,s,G,I[m+6],9,3225465664),G=c(G,H,r,s,I[m+11],14,643717713),s=c(s,G,H,r,I[m+0],20,3921069994),r=c(r,s,G,H,I[m+5],5,3593408605),H=c(H,r,s,G,I[m+10],9,38016083),G=c(G,H,r,s,I[m+15],14,3634488961),s=c(s,G,H,r,I[m+4],20,3889429448),r=c(r,s,G,H,I[m+9],5,568446438),H=c(H,r,s,G,I[m+14],9,3275163606),G=c(G,H,r,s,I[m+3],14,4107603335),s=c(s,G,H,r,I[m+8],20,1163531501),r=c(r,s,G,H,I[m+13],5,2850285829),H=c(H,r,s,G,I[m+2],9,4243563512),G=c(G,H,r,s,I[m+7],14,1735328473),s=c(s,G,H,r,I[m+12],20,2368359562),r=d(r,s,G,H,I[m+5],4,4294588738),H=d(H,r,s,G,I[m+8],11,2272392833),G=d(G,H,r,s,I[m+11],16,1839030562),s=d(s,G,H,r,I[m+14],23,4259657740),r=d(r,s,G,H,I[m+1],4,2763975236),H=d(H,r,s,G,I[m+4],11,1272893353),G=d(G,H,r,s,I[m+7],16,4139469664),s=d(s,G,H,r,I[m+10],23,3200236656),r=d(r,s,G,H,I[m+13],4,681279174),H=d(H,r,s,G,I[m+0],11,3936430074),G=d(G,H,r,s,I[m+3],16,3572445317),s=d(s,G,H,r,I[m+6],23,76029189),r=d(r,s,G,H,I[m+9],4,3654602809),H=d(H,r,s,G,I[m+12],11,3873151461),G=d(G,H,r,s,I[m+15],16,530742520),s=d(s,G,H,r,I[m+2],23,3299628645),r=h(r,s,G,H,I[m+0],6,4096336452),H=h(H,r,s,G,I[m+7],10,1126891415),G=h(G,H,r,s,I[m+14],15,2878612391),s=h(s,G,H,r,I[m+5],21,4237533241),r=h(r,s,G,H,I[m+12],6,1700485571),H=h(H,r,s,G,I[m+3],10,2399980690),G=h(G,H,r,s,I[m+10],15,4293915773),s=h(s,G,H,r,I[m+1],21,2240044497),r=h(r,s,G,H,I[m+8],6,1873313359),H=h(H,r,s,G,I[m+15],10,4264355552),G=h(G,H,r,s,I[m+6],15,2734768916),s=h(s,G,H,r,I[m+13],21,1309151649),r=h(r,s,G,H,I[m+4],6,4149444226),H=h(H,r,s,G,I[m+11],10,3174756917),G=h(G,H,r,s,I[m+2],15,718787259),s=h(s,G,H,r,I[m+9],21,3951481745),r=f(r,n),s=f(s,o),G=f(G,p),H=f(H,q);var J=j(r)+j(s)+j(G)+j(H);return J.toLowerCase()}let c="";return a})();
