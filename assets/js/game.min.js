$(document).ready(()=>Game.start());var Game=(()=>{function a(a){return a?void(e=a):e}function b(){return f.lost||f.won}function c(){if(Grid.movesAvailable()||(f.lost=!0),b()){let a=f.lost?"lost":"won";setTimeout(()=>Modal.gameOverAlert(a),1500)}}function d(a){let c=b()||!GridDisplay.tilesValuesAreSet();if(!c){let b=Input.getVector(a);if(b){a.preventDefault();let c=Grid.move(b);if(c){Grid.addRandomTile();let a=Grid.getMaxMerge(!0);9999<=a&&(f.won=!0),e=f.won?9999:a,GridDisplay.refresh()}}}}let e,f;return{score:a,start:function(){e=0,f={lost:!1,won:!1},Question.load(1),Grid.build(4),Grid.addStartTiles(2),GridDisplay.refresh()},move:d,checkStatus:c}})(),Grid=(()=>{function a(){let a=m();if(a){let b=new Tile(a);n(b)}}function b(a){r=a;for(let b,c=0;c<r;c++){b=s[c]=[];for(let a=0;a<r;a++)b.push(null)}}function c(a){let b={x:[],y:[]};for(let c=0;c<r;c++)b.x.push(c),b.y.push(c);return 1===a.x&&(b.x=b.x.reverse()),1===a.y&&(b.y=b.y.reverse()),b}function d(a,b){if(0===a||0===b)return!1;return 0==a%2==(0==b%2)}function e(){let a=!1;return k((b,c,e)=>{void 0===e.floatValue&&(a=!0);for(let f=0;4>f;f++){let h=Input.getVector(null,f),i={x:b+h.x,y:c+h.y},j=g(i),k=j&&(void 0===j.floatValue||d(j.getIntValue(),e.getIntValue()));k&&(a=!0)}}),a}function f(a){return 0<=a.x&&a.x<r&&0<=a.y&&a.y<r}function g(a){return f(a)?s[a.x][a.y]:null}function h(a,b){let c;do c=a,a={x:c.x+b.x,y:c.y+b.y};while(f(a)&&null===g(a));return{farthest:c,next:a}}function i(){k((a,b,c)=>{c&&(c.parentTiles=null,c.savePosition())})}function j(a){let b=null;return k((a,c,d)=>{d&&d.isMaxMerge&&(b=d)}),a?b?b.getIntValue():0:b}function k(a){for(let b=0;b<r;b++)for(let c=0;c<r;c++)a(b,c,s[b][c])}function l(a){let b=!a&&[];return k((c,d,e)=>{e||(a?b=!0:b.push({x:c,y:d}))}),b}function m(){let a=l();if(a.length)return a[Math.floor(Math.random()*a.length)]}function n(a){s[a.x][a.y]=a}function o(a){s[a.x][a.y]=null}function p(a,b){s[a.x][a.y]=null,s[b.x][b.y]=a,a.updatePosition(b)}function q(a){let b=j();b?a.floatValue>b.floatValue&&(b.isMaxMerge=!1,a.isMaxMerge=!0,b=a):(a.isMaxMerge=!0,b=a)}let r,s=[];return{cells:s,build:b,availableCells:l,randomAvailableCell:m,insertTile:n,getMaxMerge:j,move:function(a){let b,e,f=!1,j=c(a);return i(),j.x.forEach(c=>{j.y.forEach(i=>{if(b={x:c,y:i},e=g(b),e){let c=h(b,a),i=g(c.next),j=i&&!i.parentTiles&&d(i.getIntValue(),e.getIntValue());if(!j)p(e,c.farthest);else{let a=e.floatValue+i.floatValue;9999<a&&(a=9999);let b=new Tile(c.next,a);b.parentTiles=[e,i],n(b),o(e),e.updatePosition(c.next),q(b)}f=f||b.x!==e.x||b.y!==e.y}})}),f},movesAvailable:function(){return l(!0)||e()},eachCell:k,addRandomTile:a,addStartTiles:function(b){for(let c=0;c<b;c++)a()}}})(),Modal=(()=>{function a(a){f.html(a.question)}function b(a){h.html(a.question),i.html(a.options[0]),j.html(a.options[1]),k.html(a.options[2]),l.html(a.options[3])}let c=$(".modal-qtn"),d=c.find(".modal-content"),e=$("#modal-qtn-boolean"),f=e.find(".modal-body"),g=$("#modal-qtn-options"),h=g.find(".modal-body").eq(0),i=g.find(".modal-body").eq(1),j=g.find(".modal-body").eq(2),k=g.find(".modal-body").eq(3),l=g.find(".modal-body").eq(4),m=$("#modal-qtn-carousel"),n=$("#modal-game-over"),o=$("#modal-game-won"),p=$("#modal-instructions");return $(document).on("show.bs.modal",".modal-qtn",function(){d.removeAttr("style"),m.carousel(0)}),{$qtns:c,$boolean:e,$options:g,$gameOver:n,$instructions:p,nextAnswer:function(){m.carousel("next")},move:function(a){if(d.attr("style"))return;let b=Input.getDirection(a);0===b?b="top":1===b?b="right":2===b?b="bottom":3===b?b="left":void 0;let c={};c[b]="-500px",c.opacity="0",d.animate(c,"fast").promise().then(()=>{Question.scoreAnswer(b)})},showQuestion:function(){let c=Question.get();switch(c.type){case"multiple":b(c),g.modal("show");break;case"boolean":a(c),e.modal("show");}},gameOverAlert:function(a){"lost"===a?n.modal("show"):"won"===a?o.modal("show"):void 0}}})(),Question=(()=>{function a(a){1===a&&(f=[],h=a),$.ajax({url:`${SITE_URL}game/get_questions/${h}`,dataType:"JSON",success:a=>{a.forEach(a=>{f.push(a)})},error:a=>console.log(a)}),h++}function b(){return i&&(2===f.length&&a(),g=f.shift(),i=!1),g}function c(a){let b=g.answerHash;switch(g.type){case"boolean":switch(a){case 1:return md5("True",b);case 0:return md5("False",b);}case"multiple":return md5(g.optionsTrim[a],b);}}function d(a){switch(g.type){case"boolean":switch(a){case"top":case"right":return 1;case"bottom":case"left":return 0;}case"multiple":switch(a){case"top":return 0;case"right":return 1;case"bottom":return 2;case"left":return 3;}}}function e(a){let b=d(a),e=c(b),f=g.id,h=g.level,j=0;$.ajax({url:`${SITE_URL}game/score_user_answer/${b}/${f}/${h}`,error:a=>console.log(a)}),Modal.$qtns.modal("hide");let k="boolean"===g.type?1===b?"True":"False":g.optionsTrim[b];console.log("chose: "+k),console.log("right: "+g.correct),console.log("nhash: "+e),console.log("ahash: "+g.answerHash),k===g.correct?e===g.answerHash?console.log(!0):alert(!1):e===g.answerHash?alert(!1):console.log(!0),console.log("-------------"),e===g.answerHash&&(j=g.score),GridDisplay.setTileValue(parseFloat(j)),i=!0}let f,g,h=1,i=!0;return{load:a,get:b,scoreAnswer:e}})(),GridDisplay=(()=>{function a(){l.empty(),g=Game.score(),l.text(g)}function b(a){let b=a.x+1,c=a.y+1;return"tile-position-"+b+"-"+c}function c(){return f=$(h).eq(0),f.length?"visible"===k.css("visibility")?void k.css("visibility","hidden"):void Modal.showQuestion():void 0}function d(a){let b=Math.floor(a),c=f.data("x"),d=f.data("y"),e=Grid.cells[c][d];e.floatValue=a,f.text(0===a?"X":b),f.data("val-set","1"),f.addClass(0===a?"tile-zero btn-light focus disabled":0==b%2?"tile-even btn-primary focus disabled":"tile-odd btn-danger focus disabled"),f.removeClass("tile-new"),Game.checkStatus()}function e(a){let c=b(a.previousPosition||a),d=void 0===a.floatValue?"tile-new":0===a.floatValue?"tile-zero":0==a.getIntValue()%2?"tile-even":"tile-odd",f=["tile",d,c],g=void 0===a.floatValue?"?":0===a.floatValue?"X":a.getIntValue();a.isMaxMerge&&f.push("tile-max");let h=$(`<div class="${f.join(" ")}" data-x="${a.x}" data-y="${a.y}" data-val-set="">${g}</div>`);a.previousPosition?window.requestAnimationFrame(()=>{f[2]=b(a),h.attr("class",f.join(" "))}):a.parentTiles&&(f.push("tile-merged"),h.attr("class",f.join(" ")),a.parentTiles.forEach(a=>{e(a)})),i.append(h)}let f,g=0,h=".tile-new",i=$("#tile-container"),j=$("#game-section"),k=$("#game-message"),l=$("#game-score"),m=$(".btn-new-game");return m.click(Game.start),{openTile:c,refresh:function(){window.requestAnimationFrame(()=>{i.empty(),Grid.eachCell((a,b,c)=>{c&&e(c)}),a(),Game.checkStatus()})},message:function(a){let b=a?"game-won":"game-over",c=a?"You win!":"Game over!";k.addClass(b),k.children("p").text(c)},updateScore:a,tilesValuesAreSet:function(){let a=!0;return $(h).each(function(){return $(this).data("val-set")||(a=!1),!1}),a},setTileValue:d}})(),Input=(()=>{function a(a){switch(a.type){case"keydown":d(a);break;case"tap":b(a);break;case"panstart":c(a);}}function b(a){let b=$(a.target),c=b.is("#game-container")||0!==b.parents("#game-container").length,d=b.is(".modal")||0!==b.parents(".modal").length;c?GridDisplay.openTile():d&&($(a.target).is(".carousel-indicators li")||Modal.nextAnswer())}function c(a){let b=$(a.target),c=b.is("#game-section")||0!==b.parents("#game-section").length,d=b.is(".modal")||0!==b.parents(".modal").length;c?Game.move(a):d&&Modal.move(a)}function d(a){if($(a.target).is(".modal")){switch(a.which){case 32:Modal.nextAnswer();break;case 38:case 37:case 40:case 39:Modal.move(a);}return}switch(a.which){case 32:GridDisplay.openTile();break;case 38:case 37:case 40:case 39:Game.move(a);}}function f(a){return{38:0,39:1,40:2,37:3,8:0,4:1,16:2,2:3}[a.which||a.direction]}let g=new Hammer(document);return $(document).on("keydown",a),g.get("pan").set({direction:Hammer.DIRECTION_ALL}),g.on("panstart tap",a),{getVector:function(a,b){if(a&&(b=f(a),void 0===b))return null;return{0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}}[b]},getDirection:f}})();function Tile(a,b){this.x=a.x,this.y=a.y,this.floatValue=b,this.isMaxMerge=!1,this.previousPosition=null,this.parentTiles=null,this.savePosition=function(){this.previousPosition={x:this.x,y:this.y}},this.updatePosition=function(a){this.x=a.x,this.y=a.y},this.getIntValue=function(){return Math.floor(this.floatValue)}}
